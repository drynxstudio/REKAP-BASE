<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rekap KSO Proyek</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-bottom: 50px; }
        .card { border: none; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 15px; }
        .history-card { background: white; padding: 15px; border-radius: 10px; border-left: 5px solid #0d6efd; margin-bottom: 10px; box-shadow: 0 1px 5px rgba(0,0,0,0.05);}
        .btn-edit { font-size: 0.8rem; padding: 2px 10px; }
        label { font-weight: 600; font-size: 0.85rem; color: #555; margin-bottom: 3px; }
        .form-control, .form-select { font-size: 0.95rem; }
    </style>
</head>
<body>

<div class="container mt-3">
    <h5 class="text-center fw-bold text-primary mb-3">REKAP PROYEK<br><small class="text-dark">CV. Danli & PT. STM</small></h5>

    <div class="card p-3">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="m-0 fw-bold" id="formTitle">üìù Input Data Baru</h6>
            <button id="btnCancelEdit" class="btn btn-sm btn-danger d-none" onclick="cancelEdit()">Batal Edit</button>
        </div>
        
        <form id="rekapForm">
            <input type="hidden" name="action" id="action" value="insert">
            <input type="hidden" name="rowIndex" id="rowIndex" value="">

            <div class="mb-2">
                <label>Tanggal</label>
                <input type="date" name="tanggal" id="tanggal" class="form-control" required>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label>Kategori</label>
                    <select name="kategori" id="kategori" class="form-select" required>
                        <option value="" disabled selected>Pilih...</option>
                        <option value="MATERIAL">MATERIAL</option>
                        <option value="UPAH">UPAH</option>
                        <option value="KANTOR">KANTOR</option>
                        <option value="TRANSPORT">TRANSPORT</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Proyek</label>
                    <select name="proyek" id="proyek" class="form-select" required>
                        <option value="" disabled selected>Pilih...</option>
                        <option value="GS">GS</option>
                        <option value="SBG">SBG</option>
                        <option value="KT">KT</option>
                    </select>
                </div>
            </div>
            <div class="mb-2">
                <label>Uraian / Pekerjaan</label>
                <input type="text" name="uraian" id="uraian" class="form-control" required>
            </div>
            <div class="row mb-2">
                <div class="col-6">
                    <label>No. Ref (Opsional)</label>
                    <input type="text" name="no" id="no" class="form-control">
                </div>
                <div class="col-6">
                    <label>Ket Tambahan</label>
                    <input type="text" name="keterangan" id="keterangan" class="form-control">
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-4">
                    <label>Vol</label>
                    <input type="number" name="volume" id="volume" class="form-control" step="any" value="1" required>
                </div>
                <div class="col-8">
                    <label>Harga Satuan (Rp)</label>
                    <input type="number" name="harga" id="harga" class="form-control" required>
                </div>
            </div>
            <button type="submit" id="btnSubmit" class="btn btn-primary w-100 fw-bold py-2">üíæ Simpan Data</button>
        </form>
    </div>

    <h6 class="fw-bold mt-4 mb-2 text-secondary d-flex justify-content-between">
        <span>üïí 10 Transaksi Terakhir</span>
        <span onclick="loadHistory()" style="cursor:pointer;">üîÑ Refresh</span>
    </h6>
    <div id="historyContainer">
        <div class="text-center text-muted my-4"><small>Memuat data...</small></div>
    </div>
</div>

<script>
    // ==========================================
    // MASUKKAN URL DEPLOY APPS SCRIPT DI BAWAH INI
    // ==========================================
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw41ZYyP-8ts3v6d3ySf2jQkEIrnOqs2iECNhBSde9kiZXUWBf-zYwgmJ5HB03AEN0/exec'; 

    const form = document.getElementById('rekapForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const historyContainer = document.getElementById('historyContainer');
    const formTitle = document.getElementById('formTitle');
    const btnCancelEdit = document.getElementById('btnCancelEdit');

    const formatRp = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka || 0);

    // Variabel global untuk menampung data history sementara
    let currentHistoryData = [];

    function loadHistory() {
        historyContainer.innerHTML = '<div class="text-center text-muted my-4"><small>üîÑ Sinkronisasi data...</small></div>';
        
        // Menambahkan parameter timestamp agar HP tidak meload cache/history lama
        fetch(scriptURL + "?t=" + new Date().getTime())
            .then(res => res.json())
            .then(data => {
                currentHistoryData = data;
                let html = '';
                if(data.length === 0) {
                    html = '<div class="text-center text-muted"><small>Belum ada data</small></div>';
                } else {
                    data.forEach((row, index) => {
                        html += `
                        <div class="history-card">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <span class="badge bg-secondary">${row.proyek} - ${row.kategori}</span>
                                <small class="text-muted">${row.tanggal}</small>
                            </div>
                            <div class="fw-bold text-dark" style="font-size:1.05rem;">${row.uraian}</div>
                            <div class="d-flex justify-content-between align-items-end mt-2">
                                <div class="text-success fw-bold">${row.volume} x ${formatRp(row.harga)} = ${formatRp(row.jumlah)}</div>
                                <button class="btn btn-outline-primary btn-edit" onclick="editData(${index})">‚úèÔ∏è Edit</button>
                            </div>
                        </div>`;
                    });
                }
                historyContainer.innerHTML = html;
            })
            .catch(err => {
                historyContainer.innerHTML = '<div class="text-center text-danger"><small>Gagal memuat history.</small></div>';
            });
    }

    function editData(index) {
        const data = currentHistoryData[index];
        
        // Ubah state form menjadi Update
        document.getElementById('action').value = 'update';
        document.getElementById('rowIndex').value = data.rowIndex;
        
        // Isi form dengan data lama
        document.getElementById('tanggal').value = data.tanggal;
        document.getElementById('kategori').value = data.kategori;
        document.getElementById('proyek').value = data.proyek;
        document.getElementById('uraian').value = data.uraian;
        document.getElementById('no').value = data.no;
        document.getElementById('keterangan').value = data.keterangan;
        document.getElementById('volume').value = data.volume;
        document.getElementById('harga').value = data.harga;

        // Ubah tampilan form
        formTitle.innerHTML = '‚úèÔ∏è Edit Data (Baris ' + data.rowIndex + ')';
        formTitle.classList.replace('text-primary', 'text-warning');
        btnSubmit.classList.replace('btn-primary', 'btn-warning');
        btnSubmit.innerHTML = 'üîÑ Update Data';
        btnCancelEdit.classList.remove('d-none');

        // Scroll otomatis ke atas
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        form.reset();
        document.getElementById('action').value = 'insert';
        document.getElementById('rowIndex').value = '';
        
        formTitle.innerHTML = 'üìù Input Data Baru';
        formTitle.classList.replace('text-warning', 'text-primary');
        btnSubmit.classList.replace('btn-warning', 'btn-primary');
        btnSubmit.innerHTML = 'üíæ Simpan Data';
        btnCancelEdit.classList.add('d-none');
    }

    form.addEventListener('submit', e => {
        e.preventDefault();
        const isUpdate = document.getElementById('action').value === 'update';
        
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = '‚è≥ Proses...';

        fetch(scriptURL, { method: 'POST', body: new FormData(form) })
            .then(response => response.text())
            .then(result => {
                alert(result); // Menampilkan pesan sukses dari script
                cancelEdit(); // Reset form kembali ke mode Insert
                loadHistory(); // Tarik data terbaru
            })
            .catch(error => {
                alert('Gagal memproses data. Cek koneksi Anda.');
            })
            .finally(() => {
                btnSubmit.disabled = false;
            });
    });

    window.onload = loadHistory;
</script>

</body>
</html>
