<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KSO Financial Ultimate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #0a0c10; --card-bg: #161a23; --accent-green: #00ff88; --accent-red: #ff3333; --accent-orange: #ff7700; --accent-yellow: #ffcc00; --text-main: #f0f0f0; --text-muted: #8b92a5; }
        body { background-color: var(--bg-dark); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-bottom: 50px; color: var(--text-main); }
        
        .title-gradient { background: linear-gradient(45deg, var(--accent-yellow), var(--accent-orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; letter-spacing: 1px; }
        .card-premium { background: var(--card-bg); border-radius: 16px; padding: 20px; border: 1px solid rgba(255, 255, 255, 0.05); box-shadow: 0 8px 25px rgba(0,0,0,0.5); margin-bottom: 20px; }
        
        /* Saldo Box */
        .saldo-box { text-align: center; margin-bottom: 20px; padding: 25px 15px; background: linear-gradient(145deg, #11141b, #0c0e12); border-radius: 20px; border: 1px solid #222; }
        .saldo-label { color: var(--text-muted); font-size: 0.8rem; font-weight: 700; letter-spacing: 2px; }
        .saldo-amount { font-size: 2.5rem; font-weight: 900; transition: color 0.3s; }
        .saldo-positive { color: var(--accent-green); text-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
        .saldo-negative { color: var(--accent-red); text-shadow: 0 0 20px rgba(255, 51, 51, 0.3); }
        
        /* Stats Grid */
        .stat-split { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border-left: 3px solid; }
        .stat-in { border-color: var(--accent-green); }
        .stat-out { border-color: var(--accent-red); }
        .stat-box .title { font-size: 0.7rem; color: var(--text-muted); font-weight: bold; }
        .stat-box .val { font-size: 1.1rem; font-weight: 800; color: #fff; }

        /* Chart Canvas Container */
        .chart-container { position: relative; height: 180px; width: 100%; display: flex; justify-content: center; align-items: center; }
        
        /* Form & Inputs */
        label { color: var(--text-muted); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .form-control, .form-select { background-color: rgba(0,0,0,0.5); border: 1px solid #333; color: #fff; border-radius: 8px; }
        .form-control:focus, .form-select:focus { background-color: rgba(0,0,0,0.8); border-color: var(--accent-orange); color: #fff; box-shadow: none; }
        option { background-color: var(--card-bg); }
        
        .btn-premium { background: linear-gradient(45deg, var(--accent-orange), var(--accent-red)); color: white; border: none; font-weight: 800; border-radius: 8px; padding: 12px; width: 100%; }
        
        /* Search & History */
        .search-box { background: rgba(0,0,0,0.4); border: 1px solid #333; color: #fff; border-radius: 20px; padding: 10px 20px; width: 100%; margin-bottom: 15px; }
        .history-card { background: rgba(0,0,0,0.2); border: 1px solid #2a2d35; padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--accent-yellow); }
        .history-card.in { border-left-color: var(--accent-green); }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="text-center mb-4">
        <h4 class="title-gradient m-0">KSO DASHBOARD</h4>
        <div style="color: var(--text-muted); font-size: 0.8rem; letter-spacing: 1px;">CV. DANLI & PT. STM</div>
    </div>

    <div class="saldo-box">
        <div class="saldo-label">SISA SALDO PROYEK</div>
        <div class="saldo-amount" id="valSaldo">Rp 0</div>
    </div>

    <div class="stat-split">
        <div class="stat-box stat-in">
            <div class="title">üì• KAS MASUK</div>
            <div class="val text-success" id="valMasuk">Rp 0</div>
        </div>
        <div class="stat-box stat-out">
            <div class="title">üì§ PENGELUARAN</div>
            <div class="val text-danger" id="valKeluar">Rp 0</div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-6">
            <div class="card-premium text-center">
                <div class="saldo-label mb-2">üî• PENGELUARAN PER PROYEK</div>
                <div class="chart-container"><canvas id="chartProyek"></canvas></div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card-premium text-center">
                <div class="saldo-label mb-2">üìä PENGELUARAN KATEGORI</div>
                <div class="chart-container"><canvas id="chartKategori"></canvas></div>
            </div>
        </div>
    </div>

    <div class="card-premium">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="m-0 fw-bold text-white" id="formTitle">‚öôÔ∏è INPUT TRANSAKSI</h6>
            <button id="btnCancelEdit" class="btn btn-sm btn-outline-danger d-none" onclick="cancelEdit()">Batal</button>
        </div>
        
        <form id="rekapForm">
            <input type="hidden" name="action" id="action" value="insert">
            <input type="hidden" name="rowIndex" id="rowIndex" value="">

            <div class="mb-3">
                <label>Tanggal</label>
                <input type="date" name="tanggal" id="tanggal" class="form-control" required>
            </div>
            <div class="row mb-3">
                <div class="col-6">
                    <label>Kategori</label>
                    <select name="kategori" id="kategori" class="form-select" required>
                        <option value="" disabled selected>Pilih...</option>
                        <option value="KAS MASUK" class="text-success fw-bold">üì• KAS MASUK</option>
                        <option value="MATERIAL">üì¶ MATERIAL</option>
                        <option value="UPAH">üë∑ UPAH</option>
                        <option value="KANTOR">üè¢ KANTOR</option>
                        <option value="TRANSPORT">üöö TRANSPORT</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Proyek</label>
                    <select name="proyek" id="proyek" class="form-select" required>
                        <option value="" disabled selected>Pilih...</option>
                        <option value="GS">GS</option>
                        <option value="SBG">SBG</option>
                        <option value="KT">KT</option>
                    </select>
                </div>
            </div>
            <div class="mb-3">
                <label>Uraian / Keterangan</label>
                <input type="text" name="uraian" id="uraian" class="form-control" required>
            </div>
            <div class="row mb-3">
                <div class="col-6">
                    <label>No. Ref (Opsional)</label>
                    <input type="text" name="no" id="no" class="form-control">
                </div>
                <div class="col-6">
                    <label>Vol</label>
                    <input type="number" name="volume" id="volume" class="form-control" step="any" value="1" required>
                </div>
            </div>
            <div class="mb-4">
                <label>Harga / Nominal Pemasukan (Rp)</label>
                <input type="number" name="harga" id="harga" class="form-control" required>
            </div>
            <button type="submit" id="btnSubmit" class="btn-premium">SIMPAN TRANSAKSI</button>
        </form>
    </div>

    <div class="mb-3">
        <input type="text" id="searchInput" class="search-box" placeholder="üîç Cari nama barang, proyek, kategori..." onkeyup="filterHistory()">
    </div>
    
    <div id="historyContainer">
        <div class="text-center text-muted my-4">Sinkronisasi database...</div>
    </div>
</div>

<script>
    // ==========================================
    // PASTE URL DEPLOY APPS SCRIPT YANG BARU DI SINI
    // ==========================================
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw41ZYyP-8ts3v6d3ySf2jQkEIrnOqs2iECNhBSde9kiZXUWBf-zYwgmJ5HB03AEN0/exec'; 

    const form = document.getElementById('rekapForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const historyContainer = document.getElementById('historyContainer');
    const formTitle = document.getElementById('formTitle');
    const btnCancelEdit = document.getElementById('btnCancelEdit');

    let currentHistoryData = [];
    let chartProyekObj = null;
    let chartKategoriObj = null;

    const formatRp = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka || 0);

    function loadHistory() {
        fetch(scriptURL + "?t=" + new Date().getTime())
            .then(res => res.json())
            .then(data => {
                // 1. UPDATE SALDO & STATS
                const saldoEl = document.getElementById('valSaldo');
                saldoEl.innerText = formatRp(data.saldo);
                saldoEl.className = 'saldo-amount ' + (data.saldo >= 0 ? 'saldo-positive' : 'saldo-negative');
                
                document.getElementById('valMasuk').innerText = formatRp(data.kasMasuk);
                document.getElementById('valKeluar').innerText = formatRp(data.pengeluaran);

                // 2. RENDER CHARTS
                renderCharts(data.proyek, data.kategori);

                // 3. RENDER HISTORY
                currentHistoryData = data.history;
                renderHistoryList(currentHistoryData);
            });
    }

    function renderCharts(proyekData, kategoriData) {
        Chart.defaults.color = '#8b92a5';
        
        // Destroy old charts if exist to prevent glitch
        if(chartProyekObj) chartProyekObj.destroy();
        if(chartKategoriObj) chartKategoriObj.destroy();

        const ctxProyek = document.getElementById('chartProyek').getContext('2d');
        chartProyekObj = new Chart(ctxProyek, {
            type: 'doughnut',
            data: {
                labels: ['GS', 'SBG', 'KT'],
                datasets: [{
                    data: [proyekData.GS || 0, proyekData.SBG || 0, proyekData.KT || 0],
                    backgroundColor: ['#ff3333', '#ff7700', '#ffcc00'],
                    borderWidth: 0, hoverOffset: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });

        const ctxKategori = document.getElementById('chartKategori').getContext('2d');
        chartKategoriObj = new Chart(ctxKategori, {
            type: 'doughnut',
            data: {
                labels: ['MATERIAL', 'UPAH', 'KANTOR', 'TRANSPORT'],
                datasets: [{
                    data: [kategoriData.MATERIAL || 0, kategoriData.UPAH || 0, kategoriData.KANTOR || 0, kategoriData.TRANSPORT || 0],
                    backgroundColor: ['#00a8ff', '#9c88ff', '#fbc531', '#e84118'],
                    borderWidth: 0, hoverOffset: 5
                }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
    }

    function renderHistoryList(dataArray) {
        let html = '';
        if(dataArray.length === 0) {
            html = '<div class="text-center text-muted">Data tidak ditemukan.</div>';
        } else {
            dataArray.forEach((row, index) => {
                const isIn = row.kategori === 'KAS MASUK';
                const cardClass = isIn ? 'history-card in' : 'history-card';
                const textWarna = isIn ? 'color: var(--accent-green);' : 'color: var(--accent-yellow);';
                
                html += `
                <div class="${cardClass}">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>
                            <span class="badge" style="background: rgba(255,255,255,0.1); border: 1px solid #555;">${row.proyek || '-'}</span>
                            <span class="badge ms-1" style="background: rgba(255,255,255,0.1); border: 1px solid #555;">${row.kategori || '-'}</span>
                        </div>
                        <small style="color:#666;">${row.tanggal}</small>
                    </div>
                    <div class="fw-bold text-white mb-1">${row.uraian}</div>
                    <div class="d-flex justify-content-between align-items-end mt-2">
                        <div style="${textWarna} font-weight:800; font-size:1.1rem;">
                            ${isIn ? '+' : '-'}${formatRp(row.jumlah)}
                            <div style="color:var(--text-muted); font-size:0.7rem; font-weight:normal;">Vol: ${row.volume} | Hrg: ${formatRp(row.harga)}</div>
                        </div>
                        <button class="btn btn-sm btn-outline-secondary text-white" style="font-size:0.7rem;" onclick="editData(${row.rowIndex})">EDIT</button>
                    </div>
                </div>`;
            });
        }
        historyContainer.innerHTML = html;
    }

    // Fitur Live Search
    function filterHistory() {
        const keyword = document.getElementById('searchInput').value.toLowerCase();
        const filtered = currentHistoryData.filter(row => 
            (row.uraian && row.uraian.toLowerCase().includes(keyword)) || 
            (row.proyek && row.proyek.toLowerCase().includes(keyword)) ||
            (row.kategori && row.kategori.toLowerCase().includes(keyword))
        );
        renderHistoryList(filtered);
    }

    function editData(realRowIndex) {
        // Cari data aslinya berdasarkan rowIndex
        const data = currentHistoryData.find(r => r.rowIndex === realRowIndex);
        if(!data) return;

        document.getElementById('action').value = 'update';
        document.getElementById('rowIndex').value = data.rowIndex;
        document.getElementById('tanggal').value = data.tanggal;
        document.getElementById('kategori').value = data.kategori;
        document.getElementById('proyek').value = data.proyek;
        document.getElementById('uraian').value = data.uraian;
        document.getElementById('no').value = data.no || '';
        document.getElementById('volume').value = data.volume;
        document.getElementById('harga').value = data.harga;

        formTitle.innerHTML = '‚öôÔ∏è UPDATE BARIS ' + data.rowIndex;
        formTitle.style.color = 'var(--accent-yellow)';
        btnSubmit.innerHTML = 'SIMPAN PERUBAHAN';
        btnCancelEdit.classList.remove('d-none');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function cancelEdit() {
        form.reset();
        document.getElementById('action').value = 'insert';
        document.getElementById('rowIndex').value = '';
        formTitle.innerHTML = '‚öôÔ∏è INPUT TRANSAKSI';
        formTitle.style.color = '#fff';
        btnSubmit.innerHTML = 'SIMPAN TRANSAKSI';
        btnCancelEdit.classList.add('d-none');
    }

    form.addEventListener('submit', e => {
        e.preventDefault();
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = 'MEMPROSES...';

        fetch(scriptURL, { method: 'POST', body: new FormData(form) })
            .then(response => response.text())
            .then(() => { cancelEdit(); loadHistory(); })
            .catch(() => alert('Gagal! Coba lagi.'))
            .finally(() => btnSubmit.disabled = false);
    });

    window.onload = loadHistory;
</script>

</body>
</html>
