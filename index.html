<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KSO Financial Ultimate</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #0a0c10; --card-bg: #161a23; --accent-green: #00ff88; --accent-red: #ff3333; --accent-orange: #ff7700; --accent-yellow: #ffcc00; --text-main: #f0f0f0; --text-muted: #8b92a5; }
        
        /* PREMIUM BACKGROUND */
        body { 
            background: radial-gradient(circle at top right, #1a1f2b 0%, var(--bg-dark) 50%, var(--bg-dark) 100%);
            background-attachment: fixed;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding-bottom: 50px; 
            color: var(--text-main); 
        }
        /* Grid Texture overlay */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: linear-gradient(rgba(255,255,255,0.02) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 30px 30px; z-index: -1; pointer-events: none;
        }
        
        .header-logo img { height: 45px; object-fit: contain; border-radius: 4px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.5)); }
        .title-gradient { background: linear-gradient(45deg, var(--accent-yellow), var(--accent-orange)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900; letter-spacing: 1px; }
        
        /* Saldo Box */
        .saldo-box { text-align: center; margin-bottom: 20px; padding: 25px 15px; background: linear-gradient(145deg, #11141b, #0c0e12); border-radius: 20px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .saldo-label { color: var(--text-muted); font-size: 0.8rem; font-weight: 700; letter-spacing: 2px; }
        .saldo-amount { font-size: 2.5rem; font-weight: 900; transition: color 0.3s; }
        .saldo-positive { color: var(--accent-green); text-shadow: 0 0 20px rgba(0, 255, 136, 0.3); }
        .saldo-negative { color: var(--accent-red); text-shadow: 0 0 20px rgba(255, 51, 51, 0.3); }
        
        /* Stats Grid */
        .stat-split { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-box { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 12px; border-left: 3px solid; backdrop-filter: blur(5px); }
        .stat-in { border-color: var(--accent-green); }
        .stat-out { border-color: var(--accent-red); }
        .stat-box .title { font-size: 0.7rem; color: var(--text-muted); font-weight: bold; }
        .stat-box .val { font-size: 1.1rem; font-weight: 800; color: #fff; }
        .detail-row { display: flex; justify-content: space-between; font-size: 0.8rem; margin-top: 5px; color: #ccc; border-bottom: 1px dashed #333; padding-bottom: 2px; }

        .chart-container { position: relative; height: 180px; width: 100%; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0.3); border-radius: 12px; padding: 10px; border: 1px solid #222;}
        
        .btn-premium { background: linear-gradient(45deg, var(--accent-orange), var(--accent-red)); color: white; border: none; font-weight: 800; border-radius: 12px; padding: 14px; width: 100%; box-shadow: 0 5px 15px rgba(255,119,0,0.3); letter-spacing: 1px; }
        .btn-outline-stats { border: 1px solid #444; color: var(--text-main); border-radius: 12px; padding: 10px; width: 100%; font-weight: bold; background: rgba(255,255,255,0.05); transition: 0.3s; }
        
        .modal-content { background-color: var(--card-bg); border: 1px solid #444; color: white; border-radius: 16px; box-shadow: 0 15px 50px rgba(0,0,0,0.8); }
        .modal-header { border-bottom: 1px solid #333; }
        .btn-close-custom { background: transparent; border: none; color: white; font-size: 1.5rem; line-height: 1; }
        
        label { color: var(--text-muted); font-size: 0.75rem; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .form-control, .form-select { background-color: rgba(0,0,0,0.5); border: 1px solid #333; color: #fff; border-radius: 8px; }
        .form-control:focus, .form-select:focus { background-color: rgba(0,0,0,0.8); border-color: var(--accent-orange); color: #fff; box-shadow: none; }
        option { background-color: var(--card-bg); }
        
        .search-box { background: rgba(0,0,0,0.5); border: 1px solid #444; color: #fff; border-radius: 20px; padding: 10px 20px; width: 100%; margin-bottom: 15px; }
        .history-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; margin-bottom: 10px; border-left: 4px solid var(--accent-yellow); backdrop-filter: blur(5px); transition: transform 0.2s; }
        .history-card:active { transform: scale(0.98); }
        .history-card.in { border-left-color: var(--accent-green); }
        
        .export-btn { font-size: 0.8rem; font-weight: bold; letter-spacing: 1px; border-radius: 8px; padding: 10px; display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* PRINT STYLES UNTUK EXPORT PDF (NATIVE & RAPI) */
        @media print {
            body { background: white !important; color: black !important; padding: 0; margin: 0; }
            body::before { display: none; }
            .no-print { display: none !important; }
            .saldo-box, .stat-box { border: 1px solid #000; background: transparent; color: black; box-shadow: none; }
            .title-gradient { -webkit-text-fill-color: black; color: black; }
            .saldo-positive, .saldo-negative, .text-success, .text-danger, .text-white, .text-muted { color: black !important; text-shadow: none; }
            #printTable { display: table !important; width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px;}
            #printTable th, #printTable td { border: 1px solid black; padding: 6px; text-align: left; }
            #printTable th { background-color: #f0f0f0; }
        }
        #printTable { display: none; }
    </style>
</head>
<body>

<div class="container mt-4">
    <div class="d-flex justify-content-center align-items-center mb-3 gap-3 header-logo no-print">
        <img src="dan-logo.png" alt="DAN" onerror="this.style.display='none'">
        <div class="text-center">
            <h4 class="title-gradient m-0">KSO DASHBOARD</h4>
            <div style="color: var(--text-muted); font-size: 0.75rem; letter-spacing: 2px;">CV. DANLI & PT. STM</div>
        </div>
        <img src="stm-logo.png" alt="STM" onerror="this.style.display='none'">
    </div>

    <div class="saldo-box">
        <div class="saldo-label">SISA SALDO KESELURUHAN</div>
        <div class="saldo-amount" id="valSaldo">Rp 0</div>
    </div>

    <button type="button" class="btn btn-premium mb-3 no-print" onclick="openModalForNew()">‚ûï INPUT TRANSAKSI BARU</button>

    <button class="btn btn-outline-stats mb-4 no-print" type="button" data-bs-toggle="collapse" data-bs-target="#detailDashboard">
        üìä BUKA DETAIL PROYEK & KATEGORI ‚ñº
    </button>

    <div class="collapse no-print" id="detailDashboard">
        <div class="stat-split">
            <div class="stat-box stat-in">
                <div class="title text-center mb-2">üì• KAS MASUK PROYEK</div>
                <div class="val text-success text-center mb-2" id="valMasuk">Rp 0</div>
                <div class="detail-row"><span>GS</span><span id="inGS">0</span></div>
                <div class="detail-row"><span>SBG</span><span id="inSBG">0</span></div>
                <div class="detail-row" style="border:none;"><span>KT</span><span id="inKT">0</span></div>
            </div>
            <div class="stat-box stat-out">
                <div class="title text-center mb-2">üì§ PENGELUARAN PROYEK</div>
                <div class="val text-danger text-center mb-2" id="valKeluar">Rp 0</div>
                <div class="detail-row"><span>GS</span><span id="outGS">0</span></div>
                <div class="detail-row"><span>SBG</span><span id="outSBG">0</span></div>
                <div class="detail-row" style="border:none;"><span>KT</span><span id="outKT">0</span></div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-6">
                <div class="chart-container"><canvas id="chartProyek"></canvas></div>
            </div>
            <div class="col-6">
                <div class="chart-container"><canvas id="chartKategori"></canvas></div>
                <div class="stat-box mt-3 p-2" style="border-left-color: var(--accent-orange);">
                    <div class="detail-row mt-0"><span>MAT</span><span id="catMat">0</span></div>
                    <div class="detail-row"><span>UPAH</span><span id="catUpah">0</span></div>
                    <div class="detail-row"><span>KTR</span><span id="catKantor">0</span></div>
                    <div class="detail-row" style="border:none;"><span>TRP</span><span id="catTransport">0</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex gap-2 mb-3 no-print">
        <button class="btn btn-outline-success w-50 export-btn" onclick="exportCSV()">üìä UNDUH CSV</button>
        <button class="btn btn-outline-info w-50 export-btn" onclick="exportPDF()">üìÑ CETAK PDF</button>
    </div>

    <input type="text" id="searchInput" class="search-box no-print" placeholder="üîç Cari nama barang, proyek, kategori..." onkeyup="filterHistory()">
    
    <div id="historyContainer" class="no-print">
        <div class="text-center text-muted my-4">Sinkronisasi database (Mengambil Semua Data)...</div>
    </div>

    <table id="printTable">
        <thead>
            <tr><th>TANGGAL</th><th>PROYEK</th><th>KATEGORI</th><th>URAIAN</th><th>KETERANGAN</th><th>VOL</th><th>HARGA</th><th>TOTAL</th></tr>
        </thead>
        <tbody id="printTableBody"></tbody>
    </table>
</div>

<div class="modal fade no-print" id="formModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h6 class="modal-title fw-bold" id="formTitle">‚öôÔ∏è INPUT TRANSAKSI</h6>
        <button type="button" class="btn-close-custom" onclick="cancelEdit()">‚úñ</button>
      </div>
      <div class="modal-body">
        <form id="rekapForm">
            <input type="hidden" name="action" id="action" value="insert">
            <input type="hidden" name="rowIndex" id="rowIndex" value="">

            <div class="row mb-3">
                <div class="col-6"><label>Tanggal</label><input type="date" name="tanggal" id="tanggal" class="form-control" required></div>
                <div class="col-6"><label>No. Ref</label><input type="text" name="no" id="no" class="form-control" placeholder="Opsional"></div>
            </div>
            <div class="row mb-3">
                <div class="col-6">
                    <label>Kategori</label>
                    <select name="kategori" id="kategori" class="form-select" required>
                        <option value="" disabled selected>Pilih...</option>
                        <option value="KAS MASUK" class="text-success fw-bold">üì• KAS MASUK</option>
                        <option value="MATERIAL">üì¶ MATERIAL</option><option value="UPAH">üë∑ UPAH</option>
                        <option value="KANTOR">üè¢ KANTOR</option><option value="TRANSPORT">üöö TRANSPORT</option>
                    </select>
                </div>
                <div class="col-6">
                    <label>Proyek</label>
                    <select name="proyek" id="proyek" class="form-select" required>
                        <option value="" disabled selected>Pilih...</option>
                        <option value="GS">GS</option><option value="SBG">SBG</option><option value="KT">KT</option>
                    </select>
                </div>
            </div>
            <div class="mb-3"><label>Uraian / Detail Barang</label><input type="text" name="uraian" id="uraian" class="form-control" required></div>
            <div class="mb-3"><label>Keterangan Tambahan</label><textarea name="keterangan" id="keterangan" class="form-control" rows="2" placeholder="Opsional..."></textarea></div>
            <div class="row mb-4">
                <div class="col-4"><label>Vol</label><input type="number" name="volume" id="volume" class="form-control" step="any" value="1" required></div>
                <div class="col-8"><label>Harga Satuan (Rp)</label><input type="number" name="harga" id="harga" class="form-control" required></div>
            </div>
            <button type="submit" id="btnSubmit" class="btn btn-premium mb-2">SIMPAN TRANSAKSI</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
    // ==========================================
    // PASTE URL DEPLOY APPS SCRIPT YANG BARU DI SINI
    // ==========================================
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw41ZYyP-8ts3v6d3ySf2jQkEIrnOqs2iECNhBSde9kiZXUWBf-zYwgmJ5HB03AEN0/exec'; 

    const form = document.getElementById('rekapForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const historyContainer = document.getElementById('historyContainer');
    const formTitle = document.getElementById('formTitle');
    const formModal = new bootstrap.Modal(document.getElementById('formModal'));

    let currentHistoryData = [];
    let chartProyekObj = null;
    let chartKategoriObj = null;

    const formatRp = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka || 0);

    function loadHistory() {
        historyContainer.innerHTML = '<div class="text-center text-muted my-4">Mengunduh seluruh data server... ‚è≥</div>';
        fetch(scriptURL + "?t=" + new Date().getTime())
            .then(res => res.json())
            .then(data => {
                // UPDATE SALDO
                const saldoEl = document.getElementById('valSaldo');
                saldoEl.innerText = formatRp(data.saldo);
                saldoEl.className = 'saldo-amount ' + (data.saldo >= 0 ? 'saldo-positive' : 'saldo-negative');
                
                document.getElementById('valMasuk').innerText = formatRp(data.kasMasuk);
                document.getElementById('valKeluar').innerText = formatRp(data.pengeluaran);

                document.getElementById('inGS').innerText = formatRp(data.inProyek.GS);
                document.getElementById('inSBG').innerText = formatRp(data.inProyek.SBG);
                document.getElementById('inKT').innerText = formatRp(data.inProyek.KT);
                document.getElementById('outGS').innerText = formatRp(data.outProyek.GS);
                document.getElementById('outSBG').innerText = formatRp(data.outProyek.SBG);
                document.getElementById('outKT').innerText = formatRp(data.outProyek.KT);

                // UPDATE ANGKA KATEGORI
                document.getElementById('catMat').innerText = formatRp(data.kategori.MATERIAL);
                document.getElementById('catUpah').innerText = formatRp(data.kategori.UPAH);
                document.getElementById('catKantor').innerText = formatRp(data.kategori.KANTOR);
                document.getElementById('catTransport').innerText = formatRp(data.kategori.TRANSPORT);

                renderCharts(data.outProyek, data.kategori);
                currentHistoryData = data.history;
                renderHistoryList(currentHistoryData);
                generatePrintTable(currentHistoryData);
            }).catch(() => { historyContainer.innerHTML = '<div class="text-danger text-center">Gagal koneksi ke server.</div>'; });
    }

    function renderCharts(proyekData, kategoriData) {
        Chart.defaults.color = '#8b92a5';
        if(chartProyekObj) chartProyekObj.destroy();
        if(chartKategoriObj) chartKategoriObj.destroy();

        const ctxP = document.getElementById('chartProyek').getContext('2d');
        chartProyekObj = new Chart(ctxP, { type: 'doughnut', data: { labels: ['GS', 'SBG', 'KT'], datasets: [{ data: [proyekData.GS||0, proyekData.SBG||0, proyekData.KT||0], backgroundColor: ['#ff3333', '#ff7700', '#ffcc00'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });

        const ctxK = document.getElementById('chartKategori').getContext('2d');
        chartKategoriObj = new Chart(ctxK, { type: 'doughnut', data: { labels: ['MAT', 'UPAH', 'KTR', 'TRP'], datasets: [{ data: [kategoriData.MATERIAL||0, kategoriData.UPAH||0, kategoriData.KANTOR||0, kategoriData.TRANSPORT||0], backgroundColor: ['#00a8ff', '#9c88ff', '#fbc531', '#e84118'], borderWidth: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } } });
    }

    function renderHistoryList(dataArray) {
        let html = '';
        if(dataArray.length === 0) { html = '<div class="text-center text-muted">Data tidak ditemukan.</div>'; } 
        else {
            dataArray.forEach((row) => {
                const isIn = row.kategori === 'KAS MASUK';
                const textWarna = isIn ? 'color: var(--accent-green);' : 'color: var(--accent-yellow);';
                html += `
                <div class="history-card ${isIn ? 'in' : ''}">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div><span class="badge bg-dark border border-secondary">${row.proyek||'-'}</span> <span class="badge bg-dark border border-secondary ms-1">${row.kategori||'-'}</span></div>
                        <small style="color:#888;">${row.tanggal}</small>
                    </div>
                    <div class="fw-bold text-white mb-1">${row.uraian}</div>
                    ${row.keterangan ? `<div style="font-size:0.75rem; color:#aaa; font-style:italic; margin-bottom:5px;">Ket: ${row.keterangan}</div>` : ''}
                    <div class="d-flex justify-content-between align-items-end mt-2">
                        <div style="${textWarna} font-weight:800; font-size:1.1rem;">${isIn ? '+' : '-'}${formatRp(row.jumlah)}
                            <div style="color:var(--text-muted); font-size:0.7rem; font-weight:normal;">Vol: ${row.volume} | Hrg: ${formatRp(row.harga)}</div>
                        </div>
                        <div>
                            <button class="btn btn-sm btn-outline-info text-white me-1" style="font-size:0.7rem;" onclick="editData(${row.rowIndex})">‚úèÔ∏è EDIT</button>
                            <button class="btn btn-sm btn-outline-danger text-white" style="font-size:0.7rem;" onclick="deleteData(${row.rowIndex})">üóëÔ∏è HAPUS</button>
                        </div>
                    </div>
                </div>`;
            });
        }
        historyContainer.innerHTML = html;
    }

    function filterHistory() {
        const key = document.getElementById('searchInput').value.toLowerCase();
        const filtered = currentHistoryData.filter(r => (r.uraian&&r.uraian.toLowerCase().includes(key)) || (r.keterangan&&r.keterangan.toLowerCase().includes(key)) || (r.proyek&&r.proyek.toLowerCase().includes(key)) || (r.kategori&&r.kategori.toLowerCase().includes(key)));
        renderHistoryList(filtered);
    }

    function openModalForNew() {
        form.reset(); document.getElementById('action').value = 'insert'; document.getElementById('rowIndex').value = '';
        formTitle.innerHTML = '‚öôÔ∏è INPUT TRANSAKSI BARU'; formTitle.style.color = '#fff';
        btnSubmit.innerHTML = 'SIMPAN TRANSAKSI'; formModal.show();
    }

    function editData(realRowIndex) {
        const data = currentHistoryData.find(r => r.rowIndex === realRowIndex);
        if(!data) return;
        document.getElementById('action').value = 'update'; document.getElementById('rowIndex').value = data.rowIndex;
        document.getElementById('tanggal').value = data.tanggal; document.getElementById('kategori').value = data.kategori;
        document.getElementById('proyek').value = data.proyek; document.getElementById('uraian').value = data.uraian;
        document.getElementById('keterangan').value = data.keterangan || ''; document.getElementById('no').value = data.no || '';
        document.getElementById('volume').value = data.volume; document.getElementById('harga').value = data.harga;
        formTitle.innerHTML = '‚öôÔ∏è UPDATE BARIS ' + data.rowIndex; formTitle.style.color = 'var(--accent-yellow)';
        btnSubmit.innerHTML = 'SIMPAN PERUBAHAN'; formModal.show();
    }

    // FITUR HAPUS DATA
    function deleteData(realRowIndex) {
        if(confirm("‚ö†Ô∏è YAKIN INGIN MENGHAPUS DATA INI?\nData yang dihapus akan hilang permanen dari Spreadsheet.")) {
            historyContainer.innerHTML = '<div class="text-center text-danger my-4">Sedang menghapus data... ‚è≥</div>';
            let formData = new FormData();
            formData.append('action', 'delete');
            formData.append('rowIndex', realRowIndex);

            fetch(scriptURL, { method: 'POST', body: formData })
                .then(res => res.text())
                .then(msg => { alert(msg); loadHistory(); }) // Reload otomatis setelah hapus
                .catch(() => { alert("Gagal Menghapus Data!"); loadHistory(); });
        }
    }

    function cancelEdit() { formModal.hide(); }

    form.addEventListener('submit', e => {
        e.preventDefault(); btnSubmit.disabled = true; btnSubmit.innerHTML = 'MEMPROSES... ‚è≥';
        fetch(scriptURL, { method: 'POST', body: new FormData(form) })
            .then(res => res.text())
            .then(() => { formModal.hide(); loadHistory(); })
            .catch(() => alert('Gagal! Coba lagi.'))
            .finally(() => btnSubmit.disabled = false);
    });

    // FITUR EXPORT CSV
    function exportCSV() {
        let csv = "TANGGAL,NO,URAIAN,KETERANGAN,VOLUME,HARGA,JUMLAH,KATEGORI,PROYEK\n";
        currentHistoryData.forEach(row => {
            let uraian = row.uraian ? row.uraian.replace(/"/g, '""') : '';
            let ket = row.keterangan ? row.keterangan.replace(/"/g, '""') : '';
            csv += `${row.tanggal},${row.no || ''},"${uraian}","${ket}",${row.volume},${row.harga},${row.jumlah},${row.kategori},${row.proyek}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `Laporan_KSO_${new Date().toISOString().slice(0,10)}.csv`;
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    // FITUR CETAK PDF (NATIVE BROWSER PRINT)
    function generatePrintTable(data) {
        let rows = '';
        data.forEach(r => {
            rows += `<tr><td>${r.tanggal}</td><td>${r.proyek||'-'}</td><td>${r.kategori||'-'}</td><td>${r.uraian}</td><td>${r.keterangan||'-'}</td><td>${r.volume}</td><td>${formatRp(r.harga)}</td><td>${formatRp(r.jumlah)}</td></tr>`;
        });
        document.getElementById('printTableBody').innerHTML = rows;
    }
    function exportPDF() { window.print(); }

    window.onload = loadHistory;
</script>

</body>
</html>
