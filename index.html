<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Rekap KSO | Danli & Swakarsa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding-top: 20px; }
        .card { box-shadow: 0 4px 8px rgba(0,0,0,0.05); border: none; border-radius: 10px; margin-bottom: 20px; }
        .header-title { color: #0d6efd; font-weight: bold; }
    </style>
</head>
<body>

<div class="container max-w-7xl">
    <h3 class="text-center header-title mb-4">REKAP PENGELUARAN PROYEK<br><small class="text-muted fs-5">CV. Danli & PT. Swakarsa Tunggal Mandiri</small></h3>

    <div class="row">
        <div class="col-lg-5">
            <div class="card p-4">
                <h5 class="mb-3">Input Data Baru</h5>
                <form id="rekapForm">
                    <div class="mb-2"><label>Tanggal</label><input type="date" name="tanggal" class="form-control" required></div>
                    <div class="row mb-2">
                        <div class="col-6"><label>No. Ref</label><input type="text" name="no" class="form-control"></div>
                        <div class="col-6"><label>Proyek</label>
                            <select name="proyek" class="form-select" required>
                                <option value="" disabled selected>Pilih...</option>
                                <option value="GS">GS (Gunung Sitoli)</option>
                                <option value="SBG">SBG (Sibolga)</option>
                                <option value="KT">KT (Kuala Tanjung)</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-2"><label>Kategori</label>
                        <select name="kategori" class="form-select" required>
                            <option value="" disabled selected>Pilih Kategori...</option>
                            <option value="MATERIAL">MATERIAL</option>
                            <option value="UPAH">UPAH</option>
                            <option value="KANTOR">KANTOR</option>
                            <option value="TRANSPORT">TRANSPORT</option>
                        </select>
                    </div>
                    <div class="mb-2"><label>Uraian</label><input type="text" name="uraian" class="form-control" required></div>
                    <div class="mb-2"><label>Keterangan</label><input type="text" name="keterangan" class="form-control"></div>
                    <div class="row mb-3">
                        <div class="col-6"><label>Volume</label><input type="number" name="volume" class="form-control" step="any" value="1" required></div>
                        <div class="col-6"><label>Harga (Rp)</label><input type="number" name="harga" class="form-control" required></div>
                    </div>
                    <button type="submit" id="btnSubmit" class="btn btn-primary w-100">Simpan Data</button>
                </form>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card p-4">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="m-0">10 Transaksi Terakhir</h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadHistory()">Refresh</button>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" style="font-size: 0.9rem;">
                        <thead class="table-dark">
                            <tr>
                                <th>Tgl</th>
                                <th>Proyek</th>
                                <th>Kategori</th>
                                <th>Uraian</th>
                                <th>Total (Rp)</th>
                            </tr>
                        </thead>
                        <tbody id="historyTable">
                            <tr><td colspan="5" class="text-center">Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ==========================================
    // MASUKKAN URL DEPLOY APPS SCRIPT DI BAWAH INI
    // ==========================================
    const scriptURL = 'https://script.google.com/macros/s/AKfycbw41ZYyP-8ts3v6d3ySf2jQkEIrnOqs2iECNhBSde9kiZXUWBf-zYwgmJ5HB03AEN0/exec'; 

    const form = document.getElementById('rekapForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const historyTable = document.getElementById('historyTable');

    // Fungsi Format Rupiah
    const formatRp = (angka) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR' }).format(angka);
    // Fungsi Format Tanggal
    const formatTgl = (tglStr) => {
        if (!tglStr) return '-';
        const d = new Date(tglStr);
        return `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`;
    };

    // 1. Fungsi Ambil Data (GET)
    function loadHistory() {
        historyTable.innerHTML = '<tr><td colspan="5" class="text-center">Memuat data dari server...</td></tr>';
        fetch(scriptURL)
            .then(response => response.json())
            .then(data => {
                let rows = '';
                if(data.length === 0) {
                    rows = '<tr><td colspan="5" class="text-center">Belum ada data</td></tr>';
                } else {
                    data.forEach(row => {
                        // row[0]=Tanggal, row[8]=Proyek, row[7]=Kategori, row[2]=Uraian, row[6]=Jumlah
                        rows += `<tr>
                            <td>${formatTgl(row[0])}</td>
                            <td><span class="badge bg-secondary">${row[8] || '-'}</span></td>
                            <td>${row[7] || '-'}</td>
                            <td>${row[2] || '-'}</td>
                            <td class="text-end fw-bold">${formatRp(row[6] || 0)}</td>
                        </tr>`;
                    });
                }
                historyTable.innerHTML = rows;
            })
            .catch(error => {
                historyTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Gagal memuat data.</td></tr>';
            });
    }

    // 2. Fungsi Simpan Data (POST)
    form.addEventListener('submit', e => {
        e.preventDefault();
        btnSubmit.disabled = true;
        btnSubmit.innerHTML = 'Menyimpan...';

        fetch(scriptURL, { method: 'POST', body: new FormData(form) })
            .then(response => response.text())
            .then(result => {
                alert('Data berhasil disimpan ke Spreadsheet!');
                form.reset();
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = 'Simpan Data';
                loadHistory(); // Refresh tabel setelah simpan
            })
            .catch(error => {
                alert('Gagal menyimpan data!');
                btnSubmit.disabled = false;
                btnSubmit.innerHTML = 'Simpan Data';
            });
    });

    // Panggil history saat web pertama kali dibuka
    window.onload = loadHistory;
</script>

</body>
</html>
